{% extends "base/base.html" %}
{% load staticfiles %}
{% load widget_tweaks %}
{% block title %} Slaves {% endblock %}
{% block premain %} {% endblock %}
{% block content %}
<div class="jumbotron">
        <div id="deleteSlaveWarning" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Warnung!</h4>
                    </div>
                    <div class="modal-body">
                        <a>Wollen Sie wirklich Slave </a>
                        <a id="deleteSlaveName" type="hidden"></a>
                        <a>l√∂schen?</a>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="deleteSlaveModalButton">Ja</button>
                        <button type="reset" class="btn btn-primary" data-dismiss="modal">Nein</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="slaveModal" role="dialog">
            <div class="modal-dialog">
                <form id="slaveForm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>

                        <div class="modal-body">
                                {% csrf_token %}

                                {% for hidden_field in form.hidden_fields %}
                                    {{ hidden_field }}
                                {% endfor %}

                                {% for field in form.visible_fields %}
                                    <div class="form-group">
                                        {{ field.label_tag }}

                                        {% if form.is_bound %}
                                            {% render_field field class="form-control is-valid" %}
                                        {% else %}
                                            {% render_field field class="form-control" %}
                                        {% endif %}

                                        {% if field.help_text %}
                                            <small class="form-text text-muted">{{ field.help_text }}</small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                        </div>
                        <div class="modal-footer">
                            <button type="reset" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary submit-btn"></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    <div id="accordion" role="tablist">
            <div class="container">
                    <div class="row">
                        <div class="col-sm">
                            <h4>Name</h4>
                        </div>
                        <div class="col-sm">
                             <h4>IP</h4>
                        </div>
                        <div class="col-sm">
                            <h4>MAC</h4>
                        </div>
                    </div>
                </div>
        {% for slave in slaves %}
        <div class="card" id="{{ slave.id }}">
            <div data-toggle="collapse" href="#collapse{{ slave.id }}"
            class="card-header collapsed" role="tab" id="headingOne"
            style="cursor:pointer">
                <a>
                    <h5 class="mb-o">
                        <div class="container">
                            <div class="row">
                                <div class="col-sm slave-name">
                                    {{ slave.name }}
                                </div>
                                <div class="col-sm slave-ip">
                                     {{ slave.ip_address }}
                                </div>
                                <div class="col-sm slave-mac">
                                     {{ slave.mac_address }}
                                </div>
                                <i class="material-icons">expand_more</i>
                            </div>
                        </div>
                    </h5>
                </a>
            </div>
            <div id="collapse{{ slave.id }}" class="collapse" role="tabpanel" data-parent="#accordion">
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary"
                        data-toggle="tooltip" data-placement="top" title="Start/Stop">
                            <i class="material-icons">power_settings_new</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Restart">
                            <i class="material-icons">refresh</i>
                        </button>
                    </div>

                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Details">
                            <i class="material-icons">info_outline</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Ping">
                            <i class="material-icons">flare</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                        data-toggle="tooltip" data-placement="top" title="Run">
                            <i class="material-icons">directions_run</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Move">
                            <i class="material-icons">compare_arrows</i>
                        </button>
                    </div>

                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary modify-slave-btn"
                         data-toggle="tooltip" data-placement="top" title="Edit">
                            <i class="material-icons">edit</i>
                        </button>
                        <button type="button" class="btn btn-primary delete_slave"
                         data-toggle="tooltip" data-placement="top" title="Delete">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="card">
            <div class="alert alert-info">
                <strong>Info!</strong> No Slaves in System. Press  <button type="button" class="btn btn-primary add-slave-btn">
                        <i class="material-icons">add</i>
                    </button> to add the first one!
            </div>
        </div>
        {% endfor %}
        <div class="card">
            <button type="button" class="btn btn-primary add-slave-btn">
            <i class="material-icons">add</i>
        </button></div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        $(".delete_slave").click(function () {
            var id = $(this).parents(".card").attr("id");
            var name = $(this).parents(".card").children().find('.slave-name').text();
            $('#deleteSlaveWarning .modal-body #deleteSlaveName').text(name);
            $('#deleteSlaveWarning').data('slaveId',id);
            $('#deleteSlaveWarning').modal('toggle');
        });

        $('#deleteSlaveModalButton').click(function () {
            var id = $('#deleteSlaveWarning').data('slaveId');
            $.ajax({
                    type: 'DELETE',
                    url: '/api/slave/' + id,
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    success: function (err) {
                        if ($.isEmptyObject(err)) {
                            window.location.reload();
                        } else {
                            throw_error(id, JSON.stringify(err));
                        }
                    }
            })
        });

        // Error Display for Slave-Kontextmenu
        function throw_error(id, err) {
            $('#collapse'+id).append('<div class="alert alert-danger"><strong>Error!</strong> '+err+'</div>');
        }

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        //opens the slaveModal to add a new slave
        $('.add-slave-btn').click(function () {
            slaveModal = $('#slaveModal');

            //modify the form for the submit button
            slaveForm = slaveModal.children().find('#slaveForm');
            slaveForm.attr('action','/api/slaves');
            slaveForm.attr('method','POST');
            slaveForm.children().find('.submit-btn').text('Add');

            //clear input fields
            slaveForm.find("input[name='name']").val("");
            slaveForm.find("input[name='ip_address']").val("");
            slaveForm.find("input[name='mac_address']").val("");

            slaveModal.modal('toggle');
        });

        //opens the slaveModal to modify an existing slave
        $('.modify-slave-btn').click(function () {
            //get info of slave
            var card = $(this).parents('.card');
            var id = card.attr("id");
            var name = card.children().find('.slave-name').text().trim();
            var ip = card.children().find('.slave-ip').text().trim();
            var mac = card.children().find('.slave-mac').text().trim();

            slaveModal = $('#slaveModal');

            //modify the form for the submit button
            slaveForm = slaveModal.children().find('#slaveForm');
            slaveForm.attr('action','/api/slave/'+id);
            slaveForm.attr('method','PUT');
            slaveForm.children().find('.submit-btn').text('Edit');

            //insert values into input field
            slaveForm.find("input[name='name']").val(name);
            slaveForm.find("input[name='ip_address']").val(ip);
            slaveForm.find("input[name='mac_address']").val(mac);

            //open modal
            slaveModal.modal('toggle');
        });

        // Form Handler
        $('#slaveForm').submit(function (event) {
            //Stop form from submitting normally
            event.preventDefault();

            //send request to given url and with given method
            //data field contains information about the slave
            $.ajax({
                    type: $(this).attr('method'),
                    url: $(this).attr('action'),
                    data: {
                        name: $(this).find("input[name='name']").val(),
                        ip_address: $(this).find("input[name='ip_address']").val(),
                        mac_address: $(this).find("input[name='mac_address']").val()
                    },
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                    },
                    success: function(err){
                        if($.isEmptyObject(err)){
                            window.location.reload();
                        } else {
                            $("#slaveForm").find("div[class='invalid-feedback']").each(function (index, item) {
                                item.remove();
                            });

                            $("#slaveForm").find(".is-invalid").each(function (index, item) {
                                console.log(item);
                                $(item).addClass("is-valid");
                                $(item).removeClass("is-invalid");
                            });

                            $.each(err, function (id, msg) {
                                node = $("#slaveForm").find("input[name=" + id +"]");
                                node.addClass("is-invalid");
                                node.parent().append('<div class="invalid-feedback">' + msg + '</div>');
                            });
                        }
                    }
            });
        })
    });
</script>
{% endblock %}
