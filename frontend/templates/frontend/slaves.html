{% extends "base/base.html" %}
{% load staticfiles %}
{% load widget_tweaks %}
{% block title %} Slaves {% endblock %}
{% block premain %} {% endblock %}
{% block content %}
<div class="jumbotron">
        <div class="modal fade" id="registerSlaveModal" role="dialog">
            <div class="modal-dialog">
                <form action="/api/slaves/" method="post" id="form_slave">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>

                        <div class="modal-body">
                                {% csrf_token %}

                                {% for hidden_field in form.hidden_fields %}
                                    {{ hidden_field }}
                                {% endfor %}

                                {% for field in form.visible_fields %}
                                    <div class="form-group">
                                        {{ field.label_tag }}

                                        {% if form.is_bound %}
                                            {% render_field field class="form-control is-valid" %}
                                        {% else %}
                                            {% render_field field class="form-control" %}
                                        {% endif %}

                                        {% if field.help_text %}
                                            <small class="form-text text-muted">{{ field.help_text }}</small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                        </div>
                        <div class="modal-footer">
                            <button type="reset" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    <div id="accordion" role="tablist">
            <div class="container">
                    <div class="row">
                        <div class="col-sm">
                            <h4>Name</h4>
                        </div>
                        <div class="col-sm">
                             <h4>IP</h4>
                        </div>
                        <div class="col-sm">
                            <h4>MAC</h4>
                        </div>
                    </div>
                </div>
        {% for slave in slaves %}
        <div class="card" id="{{ slave.id }}">
            <div data-toggle="collapse" href="#collapse{{ slave.id }}"
            class="card-header collapsed" role="tab" id="headingOne"
            style="cursor:pointer">
                <a>
                    <h5 class="mb-o">
                        <div class="container">
                            <div class="row">
                                <div class="col-sm">
                                    {{ slave.name }}
                                </div>
                                <div class="col-sm">
                                     {{ slave.ip_address }}
                                </div>
                                <div class="col-sm">
                                     {{ slave.mac_address }}
                                </div>
                                <i class="material-icons">expand_more</i>
                            </div>
                        </div>
                    </h5>
                </a>
            </div>
            <div id="collapse{{ slave.id }}" class="collapse" role="tabpanel" data-parent="#accordion">
                <div class="card-body">
                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button type="button" class="btn btn-primary"
                        data-toggle="tooltip" data-placement="top" title="Start/Stop">
                            <i class="material-icons">power_settings_new</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Restart">
                            <i class="material-icons">refresh</i>
                        </button>
                    </div>

                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Details">
                            <i class="material-icons">info_outline</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Ping">
                            <i class="material-icons">flare</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                        data-toggle="tooltip" data-placement="top" title="Run">
                            <i class="material-icons">directions_run</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Move">
                            <i class="material-icons">compare_arrows</i>
                        </button>
                    </div>

                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Edit">
                            <i class="material-icons">edit</i>
                        </button>
                        <button type="button" class="btn btn-primary"
                         data-toggle="tooltip" data-placement="top" title="Delete">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="card"><a>No Slaves found.</a></div>
        {% endfor %}
        <div class="card">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#registerSlaveModal">
            <i class="material-icons">add</i>
        </button></div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function(){
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
        $("#form_slave").submit(function (event) {
            //Stop form from submitting normally
            event.preventDefault();

            //get data from form
            url = $(this).attr("action")
            name = $(this).find("input[name='name']").val();
            ip_address = $(this).find("input[name='ip_address']").val();
            mac_address = $(this).find("input[name='mac_address']").val();

            $.post(url,
             {
                csrfmiddlewaretoken:'{{ csrf_token }}',
                name: name,
                ip_address: ip_address,
                mac_address: mac_address
            },
            function(err){
                if($.isEmptyObject(err)){
                    window.location.reload();
                } else {
                    $("#form_slave").find("div[class='invalid-feedback']").each(function (index, item) {
                        item.remove();
                    });

                    $("#form_slave").find(".is-invalid").each(function (index, item) {
                        console.log(item);
                        $(item).addClass("is-valid");
                        $(item).removeClass("is-invalid");
                    });

                    $.each(err, function (id, msg) {
                        node = $("#form_slave").find("input[name=" + id +"]");
                        node.addClass("is-invalid");
                        node.parent().append('<div class="invalid-feedback">' + msg + '</div>');
                    });
                }
            });
        })
    })
</script>
{% endblock %}
