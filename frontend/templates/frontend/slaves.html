{% extends "base/base.html" %} 
{% load staticfiles %} 
{% load widget_tweaks %} 
{% block title %} Slaves {% endblock %} 
{% block premain %} 
{% endblock %} 
{% block content %}
<div class="jumbotron" style=" ">

    <!-- Modal for deletion warnings used for slave and program deletion-->
    <div id="deleteWarning" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content"
            style=" ">
                <div class="modal-header">
                    <h4 class="modal-title">Deletion Warning!</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type='button' class='btn btn-info' id='deleteSlaveModalButton'>OK</button>
                    <button type='button' class='btn btn-info' id='deleteProgramModalButton'>OK</button>
                    <button type='reset' class='btn btn-danger' data-dismiss='modal'>Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="programModal" role="dialog">
        <div class="modal-dialog">
            <form id="programForm">
                <div class="modal-content"
                style=" ">
                    <div class="modal-header">
                        <h4 class="modal-title"></h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <div class="modal-body">
                        {% csrf_token %}
                        {% for hidden_field in program_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}
                        {% for field in program_form.visible_fields %}
                        <div class="form-group">
                            {{ field.label_tag }}
                            {% if program_form.is_bound %}
                                {% render_field field class="form-control is-valid" %}
                            {% else %}
                                {% render_field field class="form-control" %}
                            {% endif %}
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-info submit-btn"></button>
                        <button type="reset" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <div class="modal fade" id="slaveModal" role="dialog">
        <div class="modal-dialog">
            <form id="slaveForm">
                <div class="modal-content"
                style=" ">
                    <div class="modal-header">
                        <h4 class="modal-title"></h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <div class="modal-body">
                        {% csrf_token %}
                        {% for hidden_field in slave_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}
                        {% for field in slave_form.visible_fields %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {% if slave_form.is_bound %}
                                    {% render_field field class="form-control is-valid" %}
                                {% else %}
                                    {% render_field field class="form-control" %}
                                {% endif %}
                                {% if field.help_text %}
                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-info submit-btn"></button>
                        <button type="reset" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <h4>Clients</h4>
    <div id="accordion" role="tablist">
        {% for slave in slaves %}
            <div class="card slave-card mb-2" id="{{ slave.id }}"
            style="">
                <div class="card-header collapsed">
                    <div class="row">
                        <div class="slave-name col">
                            <h5 class="mt-2">{{ slave.name }}</h5>
                        </div>
                        <div class="btn-toolbar" role="toolbar">
                            <div class="btn-group mr-4" role="group">
                                <button type="button" class="btn btn-danger" data-toggle="tooltip" data-placement="top" title="Status">
                                    <i class="material-icons">error_outline</i>
                                </button>
                            </div>

                            <div class="btn-group mr-2" role="group">
                                <button type="button" class="btn btn-outline-light start" data-toggle="tooltip" data-placement="top" title="Start/Stop">
                                    <i class="material-icons">power_settings_new</i>
                                </button>
                                <button type="button" class="btn btn-outline-light" data-toggle="tooltip" data-placement="top" title="Restart">
                                    <i class="material-icons">refresh</i>
                                </button>
                            </div>

                            <div class="btn-group mr-2" role="group">
                                <button type="button" class="btn btn-outline-info" data-toggle="tooltip" data-placement="top" title="Delete File">
                                    <i class="material-icons">signal_cellular_no_sim</i>
                                </button>
                                <button type="button" class="btn btn-outline-info" data-toggle="tooltip" data-placement="top" title="Copy File">
                                    <i class="material-icons">insert_drive_file</i>
                                </button>
                            </div>

                            <div class="btn-group mr-4" role="group">
                                <button type="button" class="btn btn-outline-danger modify-slave-btn" data-toggle="tooltip" data-placement="top" title="Edit">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" class="btn btn-outline-danger delete_slave" data-toggle="tooltip" data-placement="top" title="Delete">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                            <div class="btn-group mr-2" role="group" data-toggle="collapse" href="#collapse{{ slave.id }}">
                                <button type="button" class="btn btn-outline-secondary" data-toggle="tooltip" data-placement="top" title="Show More" id="headingOne">
                                    <i class="material-icons">expand_more</i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="collapse{{ slave.id }}" class="collapse" role="tabpanel">
                    <div class="card-body card-inverse">
                        <div class="row">
                            <div class="col">
                                <p>IP:
                                    <b class="slave-ip">{{ slave.ip_address }}</b>
                                </p>
                            </div>
                            <div class="col">
                                <p>MAC:
                                    <b class="slave-mac">{{ slave.mac_address }}</b>
                                </p>
                            </div>
                        </div>
                        <h5>Programs</h5>
                        {% for program in slave.program_set.all %}
                            <div class="card program-card mb-2" data-id="{{ program.id }}"
                            style="background-">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="program-name col">
                                            <h5 class="mt-2">{{ program.name }}</h5>
                                        </div>
                                        <div class="program-path" style="display: none;">{{ program.path }}</div>
                                        <div class="program-arguments" style="display: none">{{ program.arguments }}</div>
                                        <div class="btn-toolbar" role="toolbar">
                                            <div class="btn-group mr-4" role="group">
                                                <button type="button" class="btn btn-danger" data-toggle="tooltip" data-placement="top" title="Status">
                                                    <i class="material-icons">error_outline</i>
                                                </button>
                                            </div>
                                            <div class="btn-group mr-2" role="group">
                                                <button type="button" class="btn btn-outline-light start-program-btn" data-toggle="tooltip" data-placement="top" title="Start/Stop">
                                                    <i class="material-icons">power_settings_new</i>
                                                </button>
                                                <button type="button" class="btn btn-outline-light" data-toggle="tooltip" data-placement="top" title="Restart">
                                                    <i class="material-icons">refresh</i>
                                                </button>
                                            </div>
                                            <div class="btn-group mr-2" role="group">
                                                <button type="button" class="btn btn-outline-danger modify-program-btn" data-toggle="tooltip" data-placement="top" title="Edit">
                                                    <i class="material-icons">edit</i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger delete_program" data-toggle="tooltip" data-placement="top" title="Delete">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="card alert alert-info">
                                <strong>Info!</strong> No programs for this client in system.
                            </div>
                        {% endfor %}
                        <button type="button" class="btn btn-outline-info float-right add-program-btn mb-4 mt-2 col" data-toggle="tooltip" data-placement="top" title="Add program">
                            <span></span>
                            <i class="material-icons" style="font-size:30px; vertical-align: middle;">add</i>
                        </button>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="card alert alert-info">
                <strong>Info!</strong> No clients in system.
            </div>
        {% endfor %}
    </div>
    <button type="button" class="btn btn-info add-slave-btn float-right mt-2 mr-2" data-toggle="tooltip" data-placement="top" title="Add client">
            <span>Client</span>
            <i class="material-icons" style="font-size:30px; vertical-align: middle;">add</i>
    </button>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function () {
        // set defaults for notifications
        $.notifyDefaults({
            type: 'success',
            placement: {
                from: 'bottom',
                align: 'right'
            },
            animate: {
                enter: 'animated fadeInRight',
                exit: 'animated fadeOutRight'
            }
        });

        /*function for deleting a slave, it is added to the delete_slave button*/
        $(".delete_slave").click(function () {

            //get id and name of the slave and create deletion message
            var id = $(this).parents(".slave-card").attr("id");
            var name = $(this).parents(".slave-card").children().find('.slave-name').text();
            var message = "<a>Are you sure you want to remove client </a><b>" + name + "</b>?</a>";

            //changing button visibility and message of the delete modal
            $('#deleteWarning .modal-footer #deleteProgramModalButton').hide();
            $('#deleteWarning .modal-footer #deleteSlaveModalButton').show();
            $('#deleteWarning .modal-body').empty(message);
            $('#deleteWarning .modal-body').append(message);


            //adding id to modal and set it visible
            $('#deleteWarning').data('slaveId', id);
            $('#deleteWarning').modal('toggle');
        });

        /*function for deleting a program, it is added to the delete_program button*/
        $(".delete_program").click(function () {

            //get id and name of the program and create deletion message
            var id = $(this).parents(".program-card").attr("data-id");
            var name = $(this).parents(".program-card").children().find('.program-name').text();
            var message = "<a>Are you sure you want to remove program </a><b>" + name + "</b>?</a>";

            //changing button visibility and message of the delete modal
            $('#deleteWarning .modal-footer #deleteSlaveModalButton').hide();
            $('#deleteWarning .modal-footer #deleteProgramModalButton').show();
            $('#deleteWarning .modal-body').empty(message);
            $('#deleteWarning .modal-body').append(message);

            //adding id to modal and set it visible
            $('#deleteWarning').data('programId', id);
            $('#deleteWarning').modal('toggle');

        });

        $('#deleteSlaveModalButton').click(function () {
            var id = $('#deleteWarning').data('slaveId');
            $.ajax({
                type: 'DELETE',
                url: '/api/slave/' + id,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                converters:{"text json": Status.from_json},
                success: function (status) {
                    if (status.is_ok()) {
                        window.location.reload();
                    } else {
                        $.notify({
                            message: JSON.stringify(response.payload)
                        }, {
                                type: 'danger'
                            });
                    }
                }
            })
        });

        $('#deleteProgramModalButton').click(function () {
            var id = $('#deleteWarning').data('programId');
            $.ajax({
                type: 'DELETE',
                url: '/api/program/' + id,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },

                converters:{"text json": Status.from_json},
                success: function (status) {
                    if (status.is_ok()){
                        window.location.reload();
                    } else {
                        $.notify({
                            message: JSON.stringify(response.payload)
                        },{
                            type: 'danger'
                        });
                    }
		        }
	        });
        });

        // Error Display for Slave-Kontextmenu
        function throw_error(id, err) {
            $('#collapse' + id).append('<div class="alert alert-danger"><strong>Error!</strong> ' + err + '</div>');
        }

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        $('.start-program-btn').click(function () {
            var id = $(this).parents(".program-card").attr("data-id");
            $.ajax({
                type: 'POST',
                url: '/api/program/' + id,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                },
                converters:{"text json": Status.from_json},
                success: function (status) {
                    if(status.is_err()){
                        $.notify({
                            message: status.payload
                        }, {
                            type: 'danger'
                        });
                    }
                },
                error: function () {
                    $.notify({
                        message: 'Error in Ajax Request.'
                    }, {
                        type: 'danger'
                    });
                }
            });
        });

        //opens the programModal to add a new program
        $('.add-program-btn').click(function () {
            programModal = $('#programModal');
            programModal.children().find('.modal-title').text("Add Program");


            //modify the form for the submit button
            programForm = programModal.children().find('#programForm');
            programForm.attr('action', '/api/programs');
            programForm.attr('method', 'POST');
            programForm.children().find('.submit-btn').text('Add');

            //clear input fields
            programForm.find("input[name='name']").val("");
            programForm.find("input[name='path']").val("");
            programForm.find("input[name='arguments']").val("");

            //clear errormessages
            programForm.find("div[class='invalid-feedback']").each(function (index, item) {
                item.remove();
            });
            programForm.find(".is-invalid").each(function (index, item) {
                $(item).removeClass("is-invalid");
            });

            //find slave id and store it in the form
            var card = $(this).parents('.slave-card');
            var id = card.attr("id");
            programForm.data('slave_id', id);

            programModal.modal('toggle');
        });

        //opens the programModal to modify a program
        $('.modify-program-btn').click(function () {
            programModal = $('#programModal');
            programForm = programModal.children().find('#programForm');

            //get info of program
            var card = $(this).parents('.program-card');
            var id = card.attr('data-id');
            var name = card.children().find('.program-name').text().trim();
            var path = card.children().find('.program-path').text().trim();
            var arguments = card.children().find('.program-arguments').text().trim();

            console.log("id:" + id + " name:" + name + " path:" + path + " args:" + arguments);

            //modify the form for the submit button
            programModal.children().find('.modal-title').text("Edit Program");
            programForm.attr('action', '/api/program/'+id);
            programForm.attr('method', 'PUT');
            programForm.children().find('.submit-btn').text('Edit');

            //clear input fields
            programForm.find("input[name='name']").val(name);
            programForm.find("input[name='path']").val(path);
            programForm.find("input[name='arguments']").val(arguments);

            //clear errormessages
            programForm.find("div[class='invalid-feedback']").each(function (index, item) {
                item.remove();
            });
            programForm.find(".is-invalid").each(function (index, item) {
                $(item).removeClass("is-invalid");
            });

            //find slave id and store it in the form
            programModal.modal('toggle');
        });

        //opens the slaveModal to add a new slave
        $('.add-slave-btn').click(function () {
            slaveModal = $('#slaveModal');
            slaveModal.children().find('.modal-title').text("Add Client");

            //modify the form for the submit button
            slaveForm = slaveModal.children().find('#slaveForm');
            slaveForm.attr('action', '/api/slaves');
            slaveForm.attr('method', 'POST');
            slaveForm.children().find('.submit-btn').text('Add');

            //clear input fields
            slaveForm.find("input[name='name']").val("");
            slaveForm.find("input[name='ip_address']").val("");
            slaveForm.find("input[name='mac_address']").val("");

            //clear errormessages
            slaveForm.find("div[class='invalid-feedback']").each(function (index, item) {
                item.remove();
            });
            slaveForm.find(".is-invalid").each(function (index, item) {
                $(item).removeClass("is-invalid");
            });

            slaveModal.modal('toggle');
        });

        //opens the slaveModal to modify an existing slave
        $('.modify-slave-btn').click(function () {
            //get info of slave
            var card = $(this).parents('.card');
            var id = card.attr("id");
            var name = card.children().find('.slave-name').text().trim();
            var ip = card.children().find('.slave-ip').text().trim();
            var mac = card.children().find('.slave-mac').text().trim();

            var slaveModal = $('#slaveModal');
            slaveModal.children().find('.modal-title').text("Edit Client");

            //modify the form for the submit button
            var slaveForm = slaveModal.children().find('#slaveForm');
            slaveForm.attr('action', '/api/slave/' + id);
            slaveForm.attr('method', 'PUT');
            slaveForm.children().find('.submit-btn').text('Edit');

            //insert values into input field
            slaveForm.find("input[name='name']").val(name);
            slaveForm.find("input[name='ip_address']").val(ip);
            slaveForm.find("input[name='mac_address']").val(mac);

            //clear errormessages
            slaveForm.find("div[class='invalid-feedback']").each(function (index, item) {
                item.remove();
            });
            slaveForm.find(".is-invalid").each(function (index, item) {
                $(item).removeClass("is-invalid");
            });

            //open modal
            slaveModal.modal('toggle');
        });

        // programForm Handler
        $('#programForm').submit(function (event) {
            //Stop form from submitting normally
            event.preventDefault();

            //send request to given url and with given method
            //data field contains information about the slave
            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: {
                    name: $(this).find("input[name='name']").val(),
                    path: $(this).find("input[name='path']").val(),
                    arguments: $(this).find("input[name='arguments']").val(),
                    slave_id: $(this).data('slave_id')
                },
                converters:{"text json": Status.from_json},
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                },
                success: function (status) {
                    if (status.is_ok()) {
                        window.location.reload();
                    } else {
                        var programForm = $('#programForm');
                        programForm.find("div[class='invalid-feedback']").each(function (index, item) {
                            item.remove();
                        });

                        programForm.find(".is-invalid").each(function (index, item) {
                            $(item).removeClass("is-invalid");
                        });


                        $.each(status.payload , function (id, msg) {
                            var node = programForm.find("input[name=" + id + "]");
                            node.addClass("is-invalid");
                            node.parent().append('<div class="invalid-feedback">' + msg + '</div>');
                        });
                    }
                },
                error: function () {
                    $.notify({
                        message: 'Error in Ajax Request.'
                    }, {
                            type: 'danger'
                        });
                }
            });
        });

        // slaveForm Handler
        $('#slaveForm').submit(function (event) {
            //Stop form from submitting normally
            event.preventDefault();
            //send request to given url and with given method
            //data field contains information about the slave
            $.ajax({
                type: $(this).attr('method'),
                url: $(this).attr('action'),
                data: {
                    name: $(this).find("input[name='name']").val(),
                    ip_address: $(this).find("input[name='ip_address']").val(),
                    mac_address: $(this).find("input[name='mac_address']").val()
                },
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                },

                converters:{"text json": Status.from_json},
                success: function(status){
                    if(status.is_ok()){
                        window.location.reload();
                    } else {
                        slaveForm = $('#slaveForm');
                        slaveForm.find("div[class='invalid-feedback']").each(function (index, item) {
                            item.remove();
                        });

                        slaveForm.find(".is-invalid").each(function (index, item) {
                            $(item).removeClass("is-invalid");
                        });


                        $.each(status.payload, function (id, msg) {
                            var node = slaveForm.find('input[name='+id+']');
                            node.addClass("is-invalid");
                            node.parent().append('<div class="invalid-feedback">' + msg + '</div>');
                        });
                    }
                },
                error: function () {
                    $.notify({
                        message: 'Error in Ajax Request.'
                    }, {
                            type: 'danger'
                        });
                }
            });
        });

	    $('.start').click(function(){
        var id = $(this).parents('.card').attr("id");
		    var el = $(this);
		    $.get({
			    url: '/api/slave/' + id + '/wol',
			    beforeSend: function(xhr){
				    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}')
			}
		    }).done(function(data){
                var status = Status.from_json(JSON.stringify(data));
			    if (status.is_ok()){
				    el.addClass('animated pulse');
				    el.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function(){
					    el.removeClass('animated pulse');
				    });
			    }
			    else{
				    $.notify({
					    message: 'Error: ' + data.payload
				    },{
					    type: 'danger'
				    });
			    }
		    }).fail(function(){
			    $.notify({
				    message: 'Error in Ajax Request.'
			    },{
				    type: 'danger'
			    });
		    });
	    });
    });
</script>
{% endblock %}
